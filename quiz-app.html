<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>QC Visual Pro - iOS Stable</title>
    
    <!-- Fonts & Scripts -->
    <link href="https://fonts.googleapis.com/css2?family=Battambang:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        :root { --primary: #0072ff; --secondary: #00c6ff; --success: #2ecc71; --danger: #e74c3c; }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Battambang', 'Microsoft YaHei', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; display: flex; justify-content: center; align-items: center; padding: 15px; }
        .container { background: white; border-radius: 30px; box-shadow: 0 20px 50px rgba(0,0,0,0.3); width: 100%; max-width: 480px; padding: 30px; text-align: center; }

        .defect-image-box { width: 100%; height: 200px; background: #f8f9fa; border-radius: 20px; margin-bottom: 15px; display: none; overflow: hidden; border: 2px solid #eef2f7; }
        .defect-image-box img { width: 100%; height: 100%; object-fit: contain; }

        input { width: 100%; padding: 18px; border: 2px solid #ddd; border-radius: 15px; font-size: 18px; margin-bottom: 20px; outline: none; text-align: center; font-family: 'Battambang'; }
        .btn-action { background: linear-gradient(to right, var(--primary), var(--secondary)); color: white; border: none; padding: 18px; border-radius: 15px; font-size: 18px; cursor: pointer; font-weight: bold; width: 100%; font-family: 'Battambang'; }

        #quiz-box, #result-box { display: none; }
        .progress-bar { width: 100%; height: 8px; background: #eee; border-radius: 10px; overflow: hidden; margin-bottom: 15px; }
        .progress-fill { height: 100%; background: var(--success); width: 0%; transition: 0.3s; }
        .chinese-word { font-size: 60px; font-weight: bold; color: #222; margin: 10px 0; }
        .speak-btn { background: #f0f4ff; border: none; width: 55px; height: 55px; border-radius: 50%; cursor: pointer; font-size: 24px; margin-bottom: 15px; }
        
        .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .option-btn { padding: 10px; border: 2px solid #f0f0f0; border-radius: 15px; background: white; cursor: pointer; font-family: 'Battambang'; font-weight: bold; font-size: 15px; min-height: 85px; }
        .correct { background: var(--success) !important; color: white !important; }
        .wrong { background: var(--danger) !important; color: white !important; animation: shake 0.4s; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
    </style>
</head>
<body>

    <div class="container">
        <!-- Login -->
        <div id="login-box">
            <h2 style="color: var(--primary);">ğŸ† QC Smart Test</h2>
            <p style="margin: 15px 0; color: #666;">á”á‰áŸ’á…á¼á›áˆáŸ’á˜áŸ„áŸ‡áŠá¾á˜áŸ’á”á¸á…á¶á”áŸ‹á•áŸ’áŠá¾á˜ááŸáŸáŸ’á</p>
            <input type="text" id="staffName" placeholder="áˆáŸ’á˜áŸ„áŸ‡á”á»á‚áŸ’á‚á›á·á€ / å§“å">
            <button class="btn-action" onclick="startApp()">á…á¼á›ášá½á˜ááŸáŸáŸ’á â”</button>
        </div>

        <!-- Quiz -->
        <div id="quiz-box">
            <div class="progress-bar"><div class="progress-fill" id="pFill"></div></div>
            <p id="staffNameDisplay" style="font-weight: bold; color: #667eea;"></p>
            <div class="defect-image-box" id="imgBox"><img id="defectImage" src=""></div>
            <div class="chinese-word" id="wordDisplay">...</div>
            <button class="speak-btn" onclick="playVoice()">ğŸ”Š</button>
            <div class="options-grid" id="optGrid"></div>
        </div>

        <!-- Result -->
        <div id="result-box">
            <h1 style="font-size: 50px;">ğŸ¥‡</h1>
            <h3 id="finalUser">...</h3>
            <div id="finalScore" style="font-size: 60px; font-weight: bold; color: var(--primary); margin: 15px 0;">0/10</div>
            <p id="sendingStatus" style="color: var(--success); font-weight: bold;">âœ… ášá€áŸ’áŸá¶á‘á»á€á–á·á“áŸ’á‘á»ášá½á…ášá¶á›áŸ‹</p>
            <button class="btn-action" style="margin-top: 25px;" onclick="location.reload()">á’áŸ’áœá¾ááŸáŸáŸ’áá˜áŸ’áŠá„á‘áŸ€á</button>
        </div>
    </div>

    <script>
        // ááŸ’á›á¹á˜áŸá¶áš Database (ášá€áŸ’áŸá¶áŠá¼á…á˜á»á“ ááŸ‚á”á„á¢á¶á…á”áŸ’áŠá¼ášáˆáŸ’á˜áŸ„áŸ‡ášá¼á”á—á¶á–á€áŸ’á“á»á„ img á±áŸ’á™ááŸ’ášá¼áœáá¶á˜ GitHub)
        const database = [
            { cn: "èµ·æ³¡", km: "á–á„ / á…á¼á›ááŸ’á™á›áŸ‹", img: "qipao.jpg" },
            { cn: "æ ‡çº¸ä¸è‰¯", km: "ááŸ‚á˜á˜á·á“á›áŸ’á¢", img: "biaozhibuliang.jpg" },
            { cn: "ä¿®è¡¥ç—•", km: "áŸáŸ’á“á¶á˜á‡á½áŸá‡á»á›", img: "xiubuhen.jpg" },
            { cn: "æ‚è´¨", km: "á’á¼á›á¸ / á€áŸ†á‘áŸá…á€áŸ†á‘á¸", img: "zhazhi.jpg" },
            { cn: "è„æ±¡", km: "á”áŸ’ášá¡á¶á€áŸ‹", img: "zangwu.jpg" },
            { cn: "æ ‡çº¸ä½ç½®ä¸å¯¹", km: "á”á·á‘ááŸ‚á˜áá»áŸá‘á¸áá¶áŸ†á„", img: "biaozhiweizhibudui.jpg" },
            { cn: "æ ‡çº¸ä¸å¯¹ç§°", km: "á”á·á‘ááŸ‚á˜á˜á·á“áŸáŸ’á˜á¾á‚áŸ’á“á¶", img: "biaozhibuduiceng.jpg" },
            { cn: "é›¾é¢", km: "áŸáŸ’ášá¢á¶á”áŸ‹", img: "wumian.jpg" },
            { cn: "æ©˜çš®", km: "áŸáŸ†á”á€á€áŸ’ášá¼á…", img: "jupi.jpg" },
            { cn: "é’ˆå­”", km: "ášá“áŸ’á’á˜áŸ’á‡á»á›", img: "zhengkong.jpg" },
            { cn: "æ¶ˆå…‰ä¸è‰¯", km: "á‘á¹á€ááŸ’á“á¶áŸ†áŸáŸ’ášá¢á¶á”áŸ‹á˜á·á“á›áŸ’á¢", img: "xiaoguangbuliang.jpg" },
            { cn: "é˜²æ¼†ä¸è‰¯", km: "á€á¶ášá–á¶ášá‘á¹á€ááŸ’á“á¶áŸ†á˜á·á“á”á¶á“á›áŸ’á¢", img: "fangqibuliang.jpg" },
            { cn: "å·¥å‚", km: "ášáŸ„á„á…á€áŸ’áš", img: "gongchang.jpg" },
            { cn: "è½¦é—´", km: "ášáŸ„á„á‡á¶á„ / á¢á¶á‚á¶áš", img: "chejian.jpg" },
            { cn: "åŠå…¬å®¤", km: "á€á¶ášá·á™á¶á›áŸá™", img: "bangongshi.jpg" },
            { cn: "ç­é•¿", km: "á”áŸ’ášá’á¶á“á€áŸ’ášá»á˜", img: "banzhang.jpg" },
            { cn: "ç¿»è¯‘", km: "á”á€á”áŸ’ášáŸ‚", img: "fanyi.jpg" },
            { cn: "æ³¨æ„å®‰å…¨", km: "á”áŸ’ášá™áŸááŸ’á“áŸá»áœááŸ’áá·á—á¶á–", img: "zhuyianquan.jpg" },
            { cn: "ä¸Šç­", km: "á…á¼á›á’áŸ’áœá¾á€á¶áš", img: "shangban.jpg" },
            { cn: "ä¸‹ç­", km: "á…áŸá‰á–á¸á’áŸ’áœá¾á€á¶áš", img: "xiaban.jpg" },
            { cn: "è¯·å‡", km: "áŸá»áŸ†á…áŸ’á”á¶á”áŸ‹", img: "qingjia.jpg" },
            { cn: "è½¦æ¶", km: "áá½á€á„áŸ‹", img: "chejia.jpg" },
            { cn: "å‰å‰", km: "á†áŸ’á–áŸ„áŸ‡á˜á»á (Fork)", img: "qiancha.jpg" },
            { cn: "è½¦æŠŠ", km: "áŠáŸƒá€á„áŸ‹", img: "cheba.jpg" },
            { cn: "è½¦åœˆ", km: "ááŸ’á“á„á€á„áŸ‹", img: "chequan.jpg" },
            { cn: "å¤–èƒ", km: "áŸáŸ†á”á€á€á„áŸ‹", img: "waitai.jpg" },
            { cn: "è„šè¸", km: "áˆáŸ’á“á¶á“áŸ‹", img: "jiaota.jpg" },
            { cn: "é“¾æ¡", km: "á…áŸ’ášáœá¶á€áŸ‹", img: "liantiao.jpg" },
            { cn: "åº§å«", km: "á€áŸ‚á”", img: "zuodian.jpg" },
            { cn: "åˆ¹è½¦", km: "á áŸ’áœáŸ’ášá¶áŸ†á„", img: "shache.jpg" },
            { cn: "æµ‹é‡å€¼", km: "áá˜áŸ’á›áŸƒáœá¶áŸáŸ‹á‡á¶á€áŸ‹áŸáŸ’ááŸ‚á„", img: "celiangzhi.jpg" },
            { cn: "æ ‡å‡†å€¼", km: "áá˜áŸ’á›áŸƒáŸáŸ’áá„áŸ‹áŠá¶", img: "biaozhunzhi.jpg" },
            { cn: "ä¸Šé™", km: "áŠáŸ‚á“á€áŸ†áááŸ‹ á›á¾", img: "shangxian.jpg" },
            { cn: "ä¸‹é™", km: "áŠáŸ‚á“á€áŸ†áááŸ‹ á€áŸ’ášáŸ„á˜", img: "xiaxian.jpg" },
            { cn: "è¶‹åŠ¿å›¾", km: "á€áŸ’ášá¶á”á“á·á“áŸ’á“á¶á€á¶áš", img: "qushitu.jpg" },
            { cn: "åˆæ ¼", km: "á‡á¶á”áŸ‹ (OK)", img: "hege.jpg" },
            { cn: "ä¸åˆæ ¼", km: "á’áŸ’á›á¶á€áŸ‹ (NG)", img: "buhege.jpg" },
            { cn: "å¼€è£‚", km: "á”áŸ’ášáŸáŸ‡ (Crack)", img: "kailie.jpg" },
            { cn: "ç„Šç ´", km: "á•áŸ’áŸá¶á’áŸ’á›á»áŸ‡", img: "hanpo.jpg" },
            { cn: "æ¼ç„Š", km: "á—áŸ’á›áŸá…á•áŸ’áŸá¶áš", img: "louhan.jpg" },
            { cn: "é’ˆçœ¼", km: "á—áŸ’á“áŸ‚á€á˜áŸ’á‡á»á›", img: "zhenyan.jpg" },
            { cn: "å‡¹é™·", km: "á€áŸ†á–á·á / á•á", img: "aoxian.jpg" },
            { cn: "ç„Šé“åå¿ƒ", km: "á•áŸ’áŸá¶ášáœáŸ€á…", img: "handaobianxin.jpg" },
            { cn: "ç”µå‡»ä¼¤", km: "á†áŸáŸ‡á˜áŸ‰á¶áŸ", img: "dianjishang.jpg" },
            { cn: "å †ç„Š", km: "á•áŸ’áŸá¶ášá‘á¼á› (Overlap)", img: "duihan.jpg" },
            { cn: "å’¬è¾¹", km: "áŸáŸŠá¸áŸá¶á…áŸ‹á”áŸ†á–á„áŸ‹", img: "yaobian.jpg" },
            { cn: "é—´éš™", km: "á…á“áŸ’á›áŸ„áŸ‡ / á á¾á”", img: "jianxi.jpg" },
            { cn: "ç¢°åˆ®ä¼¤", km: "á”áŸ‰áŸ‡á‘á„áŸ’á‚á·á… / á€áŸ„áŸ", img: "pengguashang.jpg" },
            { cn: "ç„Šæ¸£", km: "á€áŸ†á‘áŸá…á•áŸ’áŸá¶áš", img: "hanzha.jpg" }
        ];

        let userName = ""; let quizList = []; let cur = 0; let score = 0;

        // á˜á»áá„á¶ášá‡á½áŸá‡á»á›áŸá˜áŸ’á›áŸá„á›á¾ iPhone (Audio Engine Pre-warming)
        function unlockAudio() {
            const msg = new SpeechSynthesisUtterance("áŸá½áŸáŸ’áŠá¸");
            msg.volume = 0; // á¢á¶á“á¢ááŸ‹á±áŸ’á™á›áº á€áŸ’á“á»á„á–áŸá› user á…á»á…á”áŸŠá¼áá»á„ áŠá¾á˜áŸ’á”á¸á”á¾á€áŸáŸ„áš iOS
            window.speechSynthesis.speak(msg);
        }

        function playVoice() {
            window.speechSynthesis.cancel();
            const q = quizList[cur];
            const msg = new SpeechSynthesisUtterance(q.cn);
            msg.lang = 'zh-CN'; 
            msg.rate = 0.8; 
            window.speechSynthesis.speak(msg);
        }

        function startApp() {
            userName = document.getElementById('staffName').value.trim();
            if(!userName) return alert("áŸá¼á˜á”á‰áŸ’á…á¼á›áˆáŸ’á˜áŸ„áŸ‡!");
            
            unlockAudio(); // á”á¾á€áŸáŸ„ášáŸá˜áŸ’á›áŸá„á›á¾ iPhone
            
            document.getElementById('login-box').style.display = 'none';
            document.getElementById('quiz-box').style.display = 'block';
            document.getElementById('staffNameDisplay').innerText = "á”áŸá€áŸ’áá‡á“áŸ– " + userName;
            quizList = [...database].sort(() => 0.5 - Math.random()).slice(0, 10);
            showQ();
        }

        function showQ() {
            const q = quizList[cur];
            document.getElementById('wordDisplay').innerText = q.cn;
            document.getElementById('pFill').style.width = (cur / 10 * 100) + "%";
            
            const imgBox = document.getElementById('imgBox');
            const imgTag = document.getElementById('defectImage');
            if(q.img && q.img !== "") {
                imgTag.src = q.img;
                imgBox.style.display = 'block';
            } else {
                imgBox.style.display = 'none';
            }

            setTimeout(playVoice, 500);

            let wrongOnes = database.filter(x => x.km !== q.km).sort(() => 0.5 - Math.random()).slice(0, 3);
            let combined = [...wrongOnes, q].sort(() => 0.5 - Math.random());

            const grid = document.getElementById('optGrid');
            grid.innerHTML = '';
            combined.forEach(obj => {
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.innerText = obj.km;
                btn.onclick = () => {
                    document.querySelectorAll('.option-btn').forEach(b => b.disabled = true);
                    if(obj.km === q.km) { btn.classList.add('correct'); score++; }
                    else { btn.classList.add('wrong'); }
                    setTimeout(() => { 
                        cur++; 
                        if(cur < 10) showQ(); 
                        else showResult(); 
                    }, 1200);
                };
                grid.appendChild(btn);
            });
        }

        function postToGoogleSheet(name, finalPts) {
            // URL Google FormResponse á•áŸ’á›á¼áœá€á¶ášášá”áŸáŸ‹á”á„
            const url = "https://docs.google.com/forms/d/e/1FAIpQLSewAOFk30IYgR9ZIVR8yZozbbprXFzI18P-aZV6XJi8cFCUoQ/formResponse";
            
            // á”á…áŸ’á…áŸá€á‘áŸáŸá”á‰áŸ’á‡á¼á“á‘á·á“áŸ’á“á“áŸá™á±áŸ’á™á áŸ„áŸ‡á…á¼á› áŸ¡áŸ áŸ % (URL Encoded)
            const formData = new URLSearchParams();
            formData.append("entry.2026832449", name);      // á›áŸá ID áŸáŸ†áá½ášáˆáŸ’á˜áŸ„áŸ‡
            formData.append("entry.1026172260", finalPts); // á›áŸá ID áŸáŸ†áá½ášá–á·á“áŸ’á‘á»

            fetch(url, {
                method: "POST",
                mode: "no-cors",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: formData.toString()
            })
            .then(() => {
                document.getElementById('sendingStatus').innerText = "âœ… ášá€áŸ’áŸá¶á‘á»á€á€áŸ’á“á»á„ Google Sheet ášá½á…ášá¶á›áŸ‹";
            })
            .catch(() => {
                document.getElementById('sendingStatus').innerText = "âŒ á”á‰áŸ’á á¶á¢áŸŠá¸á“á’áºáá·á (áŸá¼á˜á•áŸ’á‰á¾ Screen á±áŸ’á™á˜áŸ)";
            });
        }

        function showResult() {
            document.getElementById('quiz-box').style.display = 'none';
            document.getElementById('result-box').style.display = 'block';
            document.getElementById('finalUser').innerText = "áˆáŸ’á˜áŸ„áŸ‡áŸ– " + userName;
            document.getElementById('finalScore').innerText = score + " / 10";

            if(score >= 7) confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
            
            // á áŸ…á˜á»áá„á¶ášá”á‰áŸ’á‡á¼á“á‘á·á“áŸ’á“á“áŸá™
            postToGoogleSheet(userName, score + " / 10");
        }
    </script>
</body>
</html>
